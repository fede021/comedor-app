{% extends "base.html" %}
{% block content %}
  <h1>Alta de Empleados</h1>

  <div id="qr-reader-empleados" style="width:100%; max-width:400px; margin:1em auto;"></div>
  <div style="text-align:center; margin-bottom:1em;">
    <button id="start-btn-e" type="button">Iniciar Scanner</button>
    <button id="stop-btn-e" type="button" disabled>Detener Scanner</button>
  </div>

  <form method="POST">
    <input name="dni" id="dni" placeholder="Escaneá o escribí texto completo del DNI" required>
    <input name="nombre" placeholder="Nombre" required>
    <button type="submit">Registrar</button>
  </form>

  <h2>Listado de Empleados</h2>
  <table>
    <tr><th>DNI completo</th><th>Nombre</th><th>Acción</th></tr>
    {% for e in empleados %}
      <tr>
        <td style="word-break:break-all;">{{ e.dni }}</td>
        <td>{{ e.nombre }}</td>
        <td>
          <form method="POST" action="{{ url_for('borrar_empleado', id=e.id) }}"
                onsubmit="return confirm('Seguro querés borrar a {{ e.nombre }}?');">
            <button type="submit">Borrar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
  </table>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const startBtnE = document.getElementById("start-btn-e");
    const stopBtnE  = document.getElementById("stop-btn-e");
    const html5QrCodeE = new Html5Qrcode("qr-reader-empleados");
    const configE = {
      fps: 10,
      qrbox: { width: 300, height: 300 },
      videoConstraints: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1280 },
        height: { ideal: 720 },
        focusMode: "continuous"
      }
    };

    function onScanSuccessE(decodedText) {
      document.getElementById('dni').value = decodedText;
      stopScannerE();  // detiene tras primer acierto
    }

    function startScannerE() {
      Html5Qrcode.getCameras()
        .then(cameras => {
          if (cameras && cameras.length) {
            html5QrCodeE.start(
              { deviceId: cameras[0].id },
              configE,
              onScanSuccessE,
              errorMessage => { /* opcional: console.log(errorMessage) */ }
            ).then(() => {
              startBtnE.disabled = true;
              stopBtnE.disabled  = false;
            });
          }
        })
        .catch(err => console.error('Error al iniciar cámara:', err));
    }

    function stopScannerE() {
      html5QrCodeE.stop()
        .then(() => {
          startBtnE.disabled = false;
          stopBtnE.disabled  = true;
        })
        .catch(err => console.error('Error al detener scanner:', err));
    }

    startBtnE.addEventListener("click", startScannerE);
    stopBtnE.addEventListener("click", stopScannerE);
  </script>
{% endblock %}
